import{a as P,k as U,r as c,b as B,s as g,j as e,B as p,I as m}from"./index-mjEV0DEk.js";import{L as h}from"./label-D2NWn-5R.js";function A(){const{user:i}=P(),E=U(),[l,N]=c.useState(0),w=3,S=c.useMemo(()=>Math.round((l+1)/w*100),[l]),[y,_]=c.useState(!1),[s,C]=c.useState({name:"",birthdate:"",height_cm:"",weight_kg:"",workout_duration:"25",weekly_goal:"3",username:""}),[x,b]=c.useState("idle"),{t:n}=B();c.useEffect(()=>{(async()=>{if(!i)return;const{data:a}=await g.from("profiles").select("name,birthdate,height_cm,weight_kg,username").eq("user_id",i.id).maybeSingle(),{data:r}=await g.from("preferences").select("workout_duration,weekly_goal").eq("user_id",i.id).maybeSingle();C(d=>{var f,F,k,I,j,L,v,R;return{...d,name:(a==null?void 0:a.name)??d.name,birthdate:(a==null?void 0:a.birthdate)??d.birthdate,height_cm:((F=(f=a==null?void 0:a.height_cm)==null?void 0:f.toString)==null?void 0:F.call(f))??d.height_cm,weight_kg:((I=(k=a==null?void 0:a.weight_kg)==null?void 0:k.toString)==null?void 0:I.call(k))??d.weight_kg,workout_duration:((L=(j=r==null?void 0:r.workout_duration)==null?void 0:j.toString)==null?void 0:L.call(j))??d.workout_duration,weekly_goal:((R=(v=r==null?void 0:r.weekly_goal)==null?void 0:v.toString)==null?void 0:R.call(v))??d.weekly_goal,username:(a==null?void 0:a.username)??d.username}})})()},[i==null?void 0:i.id]),c.useEffect(()=>{if(!s.username){b("idle");return}const t=setTimeout(async()=>{b("checking");const a=s.username.trim().toLowerCase();if(!/^[a-z0-9_]{3,20}$/.test(a)){b("idle");return}const{data:r}=await g.from("profiles").select("user_id").eq("username",a).maybeSingle();!r||r.user_id===(i==null?void 0:i.id)?b("available"):b("taken")},400);return()=>clearTimeout(t)},[s.username,i==null?void 0:i.id]);const u=(t,a)=>C(r=>({...r,[t]:a})),q=t=>{const a={};if(t===0){const r=s.username.trim().toLowerCase();r?/^[a-z0-9_]{3,20}$/.test(r)?x==="taken"&&(a.username=n("auth.taken")):a.username=n("auth.usernameInvalid"):a.username=n("auth.usernameRequired")}return t===1&&(s.height_cm||(a.height_cm="Required"),s.weight_kg||(a.weight_kg="Required")),t===2&&(s.workout_duration?Number(s.workout_duration)<=0&&(a.workout_duration="Invalid"):a.workout_duration="Required",s.weekly_goal?Number(s.weekly_goal)<=0&&(a.weekly_goal="Invalid"):a.weekly_goal="Required"),{valid:Object.keys(a).length===0,errors:a}},[o,M]=c.useState({}),z=()=>{const{valid:t,errors:a}=q(l);M(a),t&&N(r=>Math.min(w-1,r+1))},T=()=>N(t=>Math.max(0,t-1)),$=async()=>{if(!i)return;_(!0);const t=s.username.trim().toLowerCase();let a={};if(t){if(!/^[a-z0-9_]{3,20}$/.test(t)||x==="taken"){_(!1),alert("Username invalide ou pris");return}a.username=t}else{const{data:r}=await g.from("profiles").select("username").eq("user_id",i.id).maybeSingle();if(!(r!=null&&r.username)){_(!1),alert("Username requis");return}}await g.from("profiles").upsert({user_id:i.id,name:s.name||null,email:i.email,birthdate:s.birthdate||null,height_cm:s.height_cm?Number(s.height_cm):null,weight_kg:s.weight_kg?Number(s.weight_kg):null,...a}),await g.from("preferences").upsert({user_id:i.id,workout_duration:s.workout_duration?Number(s.workout_duration):25,weekly_goal:s.weekly_goal?Number(s.weekly_goal):3}),_(!1),E("/")};return i?e.jsx("div",{className:"min-h-[calc(100vh-3.5rem)] flex items-center justify-center p-4 min-w-0",children:e.jsxs("div",{className:"w-full max-w-xl space-y-6 border rounded-xl p-6 bg-card",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:n("onboarding.step",{current:l+1,total:w})}),e.jsxs("span",{className:"text-sm font-medium",children:[S,"%"]})]}),e.jsx("div",{className:"h-2 w-full bg-muted rounded overflow-hidden",children:e.jsx("div",{className:"h-2 bg-primary rounded-full transition-all duration-500 ease-[cubic-bezier(.16,.84,.44,1)]",style:{width:`${S}%`}})})]}),e.jsxs("div",{className:"flex flex-col",children:[l===0&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-bold mb-4",children:n("onboarding.aboutYou")})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 stagger-children flex-1 content-start",children:[e.jsxs("div",{className:"space-y-1 md:col-span-2",children:[e.jsx(h,{htmlFor:"username",children:n("auth.username")}),e.jsx(m,{id:"username",placeholder:n("auth.usernamePlaceholder"),value:s.username,onChange:t=>u("username",t.target.value)}),s.username&&e.jsx("p",{className:"text-xs text-muted-foreground",children:x==="checking"?n("auth.checking"):x==="available"?n("auth.available"):x==="taken"?n("auth.taken"):""}),o.username&&e.jsx("p",{className:"text-xs text-red-600",children:o.username})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"name",children:n("onboarding.name")}),e.jsx(m,{id:"name",placeholder:n("profileSocial.yourNamePlaceholder"),value:s.name,onChange:t=>u("name",t.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"birthdate",children:n("onboarding.birthdate")}),e.jsx(m,{id:"birthdate",type:"date",value:s.birthdate,onChange:t=>u("birthdate",t.target.value)})]})]})]}),l===1&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-bold mb-4",children:n("onboarding.bodyMetrics")})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 stagger-children flex-1 content-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"height",children:n("onboarding.heightCm")}),e.jsx(m,{id:"height",type:"number",inputMode:"numeric",value:s.height_cm,onChange:t=>u("height_cm",t.target.value)}),o.height_cm&&e.jsx("p",{className:"text-xs text-red-600",children:o.height_cm})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"weight",children:n("onboarding.weightKg")}),e.jsx(m,{id:"weight",type:"number",inputMode:"numeric",value:s.weight_kg,onChange:t=>u("weight_kg",t.target.value)}),o.weight_kg&&e.jsx("p",{className:"text-xs text-red-600",children:o.weight_kg})]})]})]}),l===2&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-bold mb-4",children:n("onboarding.preferences")})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 content-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"duration",className:"text-sm font-medium",children:n("onboarding.workoutDuration")}),e.jsx(m,{id:"duration",type:"number",inputMode:"numeric",value:s.workout_duration,onChange:t=>u("workout_duration",t.target.value),className:"[&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"}),o.workout_duration&&e.jsx("p",{className:"text-xs text-red-600",children:o.workout_duration})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(h,{htmlFor:"weekly_goal",className:"text-sm font-medium",children:n("onboarding.weeklyGoal")}),e.jsx(m,{id:"weekly_goal",type:"number",inputMode:"numeric",min:1,max:14,value:s.weekly_goal,onChange:t=>u("weekly_goal",t.target.value)}),o.weekly_goal&&e.jsx("p",{className:"text-xs text-red-600",children:o.weekly_goal})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx(p,{variant:"outline",onClick:T,disabled:l===0||y,children:n("onboarding.back")}),l<w-1?e.jsx(p,{onClick:z,children:n("onboarding.continue")}):e.jsx(p,{onClick:()=>{const{valid:t,errors:a}=q(l);M(a),t&&$()},disabled:y,children:n(y?"onboarding.saving":"onboarding.finish")})]})]})}):e.jsx("div",{className:"min-h-[calc(100vh-3.5rem)] flex items-center justify-center p-4 min-w-0",children:e.jsxs("div",{className:"w-full max-w-md space-y-4 border rounded-xl p-6 bg-card text-center",children:[e.jsx("h1",{className:"text-xl font-bold",children:n("onboarding.pleaseSignInTitle")}),e.jsx("p",{className:"text-muted-foreground",children:n("onboarding.pleaseSignInDesc")}),e.jsx("a",{href:"/login",className:"inline-block",children:e.jsx(p,{children:n("onboarding.goToLogin")})})]})})}export{A as default};
