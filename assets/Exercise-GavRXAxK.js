import{b as T,i as U,af as W,u as V,a as Z,r as u,j as t,C as ee,B as $,s as x}from"./index-BfZ5KBQI.js";import{E as te}from"./ErrorState-CpDg7nxZ.js";import{P as se}from"./PageContainer-Rz-u_6WB.js";const le=()=>{var L,R,B;const{t:r}=T(),y=U(),_=W(),{data:z}=V(),{user:l}=Z(),w=((L=_.state)==null?void 0:L.selectedDay)||"monday",o=((R=_.state)==null?void 0:R.workout)||((B=z.workoutsByDay)==null?void 0:B[w]),[n,S]=u.useState(0),[re,N]=u.useState(!1),[ae,X]=u.useState(null),[b,D]=u.useState(!1),[k,E]=u.useState(0),C=30,[v,M]=u.useState(C),d=u.useRef(null),A=e=>{if(e&&typeof e=="string"){const a=e.match(/exercise\.([^.]+)\./);if(a&&a[1])return a[1];const c={pushUps:["plank position","chest nearly touches","push back up","knee push-ups"],plankHold:["forearm plank position","straight line","squeeze your glutes","back flat"],tricepDips:["chair","gripping the edge","slide your hips","bend your elbows"],deadBug:["lie on your back","arms straight up","knees bent","lower opposite arm"],sidePlank:["lie on your side","prop up on your elbow","lift your hips","straight line"],mountainClimbers:["plank position","drive one knee","switch legs","shoulders over wrists"],squats:["feet shoulder-width apart","lower your hips","sitting in a chair","push through your heels"],reverseLunges:["step one foot back","lower your knee","front knee over your ankle","balance"],gluteBridge:["lie on your back","knees bent","lift your hips","squeezing your glutes"],catCow:["hands and knees","arch your back","dip it down","breathing deeply"],worldsGreatestStretch:["step one foot forward","lunge","rotate your torso","reach your arm up"],childsPose:["kneel on the floor","sit back on your heels","stretch your arms forward","relax your chest"],jumpingJacks:["jump feet out","raising arms overhead","return to start","step out"],walking:["walk at an easy pace","relax your shoulders","steady breathing","gentle movement"],standingQuadStretch:["stand tall","grab one ankle","knees together","hold wall for balance"],neckRolls:["stand or sit tall","roll your head","relaxing your neck","avoid sudden motions"],breathingPractice:["sit or lie down","inhale slowly","exhale longer","relaxing your body"],bodyScan:["lie down","close your eyes","scan your body","notice tension"]};for(const[g,h]of Object.entries(c))if(h.some(s=>e.toLowerCase().includes(s.toLowerCase())))return g;return"custom"}return"custom"};if(!o||!Array.isArray(o.exercises)||o.exercises.length===0)return t.jsx(te,{title:r("exercise.noData"),message:r("exercise.noDataMessage","No exercises found for this session"),retryLabel:r("exercise.goBack"),onRetry:()=>y("/workouts")});const F=(e,a)=>{const c=Math.max(0,e-a),g=c*10;if(e===0)return 0;let s=.5+.5*(c/e);return a===0&&c>0&&(s+=.25),Math.max(0,Math.round(g*s))},I=async()=>{if(!l||!o){N(!0),y("/session-complete");return}D(!0);try{const e=Array.isArray(o.exercises)?o.exercises.length:0,a=F(e,k),c=typeof o.duration=="number"?o.duration:0,{data:g,error:h}=await x.from("workout_sessions").insert({user_id:l.id,day:w,duration_min:c,completed:!0,xp_gained:a}).select("id").single();if(h)throw h;const{data:s}=await x.from("streaks").select("current_streak,best_streak,updated_at").eq("user_id",l.id).maybeSingle(),j=new Date,p=s!=null&&s.updated_at?new Date(s.updated_at):null,H=p&&p.toDateString()===j.toDateString(),O=p&&new Date(p.getFullYear(),p.getMonth(),p.getDate()+1).toDateString()===j.toDateString();let m=(s==null?void 0:s.current_streak)||0;H||(m=O?m+1:1);const P=Math.max((s==null?void 0:s.best_streak)||0,m);await x.from("streaks").upsert({user_id:l.id,current_streak:m,best_streak:P,updated_at:j.toISOString()}),await x.from("activity_feed").insert({user_id:l.id,type:"session_completed",payload:{xp:a,day:w,duration:c}}),m%7===0&&await x.from("activity_feed").insert({user_id:l.id,type:"streak",payload:{current:m}}),a>=100&&await x.from("activity_feed").insert({user_id:l.id,type:"badge",payload:{badge:"Power Hour"}});const{data:Y}=await x.from("workout_sessions").select("xp_gained").eq("user_id",l.id),J=(Y||[]).reduce((K,Q)=>K+(Q.xp_gained||0),0),q={xpGained:a,currentStreak:m,bestStreak:P,totalXp:J,skipped:k,total:e,completed:Math.max(0,e-k)};X(q),y("/session-complete",{state:{stats:q}})}catch(e){console.error(e)}finally{D(!1),N(!0)}},i=o.exercises[n],f=o.exercises.length,G=f>0?(n+1)/f*100:0;return u.useEffect(()=>(M(C),d.current&&clearInterval(d.current),d.current=setInterval(()=>{M(e=>e<=1?(d.current&&clearInterval(d.current),0):e-1)},1e3),()=>{d.current&&clearInterval(d.current)}),[n]),t.jsx(se,{title:r("exercise.sessionActive","Exercise Session"),className:"w-full flex flex-col relative min-w-0 stagger-children",autoFocus:!0,children:t.jsxs("div",{className:"flex flex-col items-center text-center flex-1 justify-center pt-4",children:[t.jsx("div",{className:"w-full max-w-xl mx-auto mb-6",children:t.jsx("div",{className:"w-full bg-muted/40 rounded-full h-2 overflow-hidden",children:t.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-500 ease-[cubic-bezier(.16,.84,.44,1)]",style:{width:`${G}%`}})})}),t.jsx(ee,{className:"w-full max-w-xl mx-auto flex flex-col py-8 px-4 sm:px-6",children:t.jsxs("div",{className:"w-full flex flex-col mb-6",children:[t.jsxs("div",{className:"flex flex-row items-center gap-3 mb-2",children:[t.jsxs("div",{className:"hidden",children:["Nom de l'exercice: ",i.name]}),t.jsxs("h3",{className:"text-2xl font-bold text-primary text-left m-0 flex items-center",children:[(()=>{const e=A(i.name);return e==="custom"?i.name||r("exercise.custom.title","Custom Exercise"):r(`exercise.${e}.title`)})(),t.jsxs("span",{className:"text-2xl font-bold text-primary ml-2 align-middle",children:["x",i.reps]})]})]}),t.jsx("div",{className:"text-md text-foreground font-medium text-left max-w-lg mb-2 leading-relaxed",children:(()=>{const e=A(i.name);return e==="custom"?i.description||i.name:r(`exercise.${e}.description`)})()}),t.jsx("div",{className:"text-base text-muted-foreground italic mb-2 text-left",children:i.modification}),t.jsx("div",{className:"text-sm text-primary font-medium text-left max-w-lg leading-relaxed",children:i.tips})]})}),t.jsxs("div",{className:"w-full max-w-xl mx-auto flex flex-col sm:flex-row gap-4 justify-center mt-8",children:[t.jsx("button",{"aria-label":"Close session",onClick:()=>y("/workouts"),className:"w-full sm:w-auto sm:h-10 sm:px-4 py-2 border border-border/40 rounded-md hover:bg-muted/40 transition flex items-center justify-center text-muted-foreground",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),t.jsx($,{variant:"outline",onClick:()=>{n<f-1?(E(e=>e+1),S(n+1)):(E(e=>e+1),I())},className:"w-full sm:w-1/2",disabled:b,children:n===f-1?r("exercise.finish"):r("exercise.skip")}),t.jsx($,{className:"w-full sm:w-1/2 btn-primary-premium",onClick:async()=>{n<f-1?S(n+1):await I()},disabled:v>0||b,children:b?"...":v>0?`${v}s`:n===f-1?r("exercise.finish"):r("exercise.next")})]})]})})};export{le as default};
