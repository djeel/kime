const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Progress-l-o51cvN.js","assets/index-mjEV0DEk.js","assets/index-Bd6WtExF.css","assets/useAsync-DvM28CX_.js","assets/progress-CG4DETrG.js","assets/ErrorState-0PO5aQxN.js","assets/stats-DASMFHN8.js","assets/PageContainer-UeT_hR_D.js","assets/flame-C9r6UAfc.js","assets/target-DWCyUt4C.js","assets/trending-up-CEFbYfNt.js","assets/Workouts-BIy3HQmc.js","assets/trash-2-D31ReXCF.js","assets/PageSkeletons-B3tiHMcf.js","assets/pencil-D9Hqk-Ve.js","assets/Profile-CqgTgkby.js","assets/award-rmq1NMA0.js"])))=>i.map(i=>d[i]);
import{r as c,s as i,j as e,k as q,b as M,t as B,I as N,B as S,ah as v}from"./index-mjEV0DEk.js";import{L as G}from"./PageSkeletons-B3tiHMcf.js";import{P as U}from"./PageContainer-UeT_hR_D.js";async function V(){const n=new Uint8Array(32);crypto.getRandomValues(n);const r=Array.from(n).map(o=>o.toString(16).padStart(2,"0")).join(""),d=new TextEncoder,l=await crypto.subtle.digest("SHA-256",d.encode(r)),p=Array.from(new Uint8Array(l)).map(o=>o.toString(16).padStart(2,"0")).join("");return{rawNonce:r,hashedNonce:p}}function $({clientId:n,onSuccess:r,onError:d,mode:l="button"}){const f=c.useRef(null);return c.useEffect(()=>((async()=>{if(!window.google||!n)return;const{rawNonce:p,hashedNonce:o}=await V();window.handleSignInWithGoogle=async m=>{try{const{data:w,error:x}=await i.auth.signInWithIdToken({provider:"google",token:m.credential,nonce:p});if(x)throw x;const a=w.user;if(a){const{data:t}=await i.from("profiles").select("username").eq("user_id",a.id).maybeSingle();if(t||await i.from("profiles").upsert({user_id:a.id,email:a.email}),!(t!=null&&t.username)){window.location.hash="#/onboarding";return}}r==null||r()}catch(w){d==null||d(w)}},l==="button"&&f.current?(window.google.accounts.id.initialize({client_id:n,callback:m=>window.handleSignInWithGoogle(m),nonce:o,use_fedcm_for_prompt:!0,auto_select:!1,context:"signin"}),window.google.accounts.id.renderButton(f.current,{theme:"outline",size:"large",shape:"pill",text:"signin_with",logo_alignment:"left"})):l==="onetap"&&(window.google.accounts.id.initialize({client_id:n,callback:m=>window.handleSignInWithGoogle(m),nonce:o,use_fedcm_for_prompt:!0,context:"signin"}),window.google.accounts.id.prompt())})(),()=>{}),[n,r,d,l]),l==="button"?e.jsx("div",{ref:f}):null}function Z(){const n=q(),[r,d]=c.useState(""),[l,f]=c.useState(""),[p,o]=c.useState(!1),[m,w]=c.useState(!0),[x,a]=c.useState(null),{t}=M(),{toast:b}=B(),[y,P]=c.useState(!1),[h,A]=c.useState("login"),[k,C]=c.useState("");c.useEffect(()=>{(async()=>{try{const{data:s}=await i.auth.getSession();if(s.session){const g=s.session.user,{data:u}=await i.from("profiles").select("username").eq("user_id",g.id).maybeSingle();if(!(u!=null&&u.username)){n("/onboarding");return}n("/");return}}finally{w(!1)}})()},[]);const E=async s=>{s.preventDefault(),o(!0),a(null);const{data:g,error:u}=await i.auth.signInWithPassword({email:r,password:l});u?a(u.message):(async()=>{try{const j=g.user;if(j){v(()=>import("./Progress-l-o51cvN.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),v(()=>import("./Workouts-BIy3HQmc.js"),__vite__mapDeps([11,1,2,3,4,5,12,13,7,9,14])),v(()=>import("./Profile-CqgTgkby.js"),__vite__mapDeps([15,1,2,5,7,14,8,16]));const{data:_}=await i.from("profiles").select("username").eq("user_id",j.id).maybeSingle();if(!(_!=null&&_.username)){n("/onboarding");return}const{fetchProgressData:D,fetchStreakOnly:W}=await v(async()=>{const{fetchProgressData:O,fetchStreakOnly:R}=await import("./stats-DASMFHN8.js");return{fetchProgressData:O,fetchStreakOnly:R}},__vite__mapDeps([6,1,2]));D(i,j.id).catch(()=>{}),W(i,j.id).catch(()=>{})}n("/")}catch{n("/")}})(),o(!1)},I=()=>{const s=l;return s.length<6?(a(t("auth.passwordTooShort")),!1):s!==k?(a(t("auth.passwordsDontMatch")),!1):!0},L=async()=>{if(o(!0),a(null),!I()){o(!1);return}const{data:s,error:g}=await i.auth.signUp({email:r,password:l});if(g)a(g.message);else{const u=s.user;u&&(await i.from("profiles").upsert({user_id:u.id,email:r}),await i.from("preferences").upsert({user_id:u.id}),n("/onboarding"))}o(!1)},T=async()=>{o(!0),a(null);try{const s=`${window.location.origin}/kime/`.replace(/\/$/,"/"),{error:g}=await i.auth.signInWithOAuth({provider:"google",options:{redirectTo:s}});g&&a(t("auth.oauthError"))}catch{a(t("auth.oauthError"))}finally{o(!1)}};return m?e.jsx(G,{}):e.jsx(U,{title:t("auth.loginTitle"),className:"min-h-screen flex items-center justify-center p-4 min-w-0",autoFocus:!0,disableSkeleton:!0,children:e.jsxs("div",{className:"w-full max-w-md space-y-8",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:t(h==="login"?"auth.loginTitle":"auth.signUp")}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h==="login"?t("auth.noAccount")+" ":t("auth.haveAccount")+" ",e.jsx("button",{type:"button",onClick:()=>{A(s=>s==="login"?"register":"login"),a(null)},className:"font-medium hover:underline",children:t(h==="login"?"auth.createOne":"auth.loginHere")})]})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),h==="login"?E(s):L()},className:"space-y-6 border rounded-2xl p-6 bg-card shadow-sm",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(N,{placeholder:t("auth.email"),"aria-label":t("auth.email"),type:"email",value:r,onChange:s=>d(s.target.value),required:!0,autoComplete:"email"}),e.jsxs("div",{className:"relative",children:[e.jsx(N,{placeholder:t("auth.password"),"aria-label":t("auth.password"),type:y?"text":"password",value:l,onChange:s=>f(s.target.value),required:!0,autoComplete:h==="login"?"current-password":"new-password",className:"pr-10"}),e.jsx("button",{type:"button","aria-label":t(y?"auth.hidePassword":"auth.showPassword"),className:"absolute inset-y-0 right-2 flex items-center text-muted-foreground hover:text-foreground focus:outline-none",onClick:()=>P(s=>!s),children:y?e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7S2 12 2 12Z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}):e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M9.88 9.88a3 3 0 0 0 4.24 4.24"}),e.jsx("path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a18.68 18.68 0 0 1-1.67 2.68"}),e.jsx("path",{d:"M6.61 6.61A18.69 18.69 0 0 0 2 12s3 7 10 7a10.4 10.4 0 0 0 5.39-1.61"}),e.jsx("line",{x1:"2",x2:"22",y1:"2",y2:"22"})]})})]}),h==="register"&&e.jsx("div",{className:"relative",children:e.jsx(N,{placeholder:t("auth.confirmPassword"),"aria-label":t("auth.confirmPassword"),type:y?"text":"password",value:k,onChange:s=>C(s.target.value),required:!0,autoComplete:"new-password"})}),h==="login"&&e.jsx("div",{className:"flex justify-end -mt-2",children:e.jsx("button",{type:"button",onClick:async()=>{if(!r){b({description:t("auth.enterEmailFirst")});return}const{error:s}=await i.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/kime/`});b(s?{description:s.message}:{description:t("auth.resetLinkSent")})},className:"text-xs text-muted-foreground hover:underline",children:t("auth.forgotPassword")})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(S,{type:"submit",disabled:p,className:"w-full",children:t(h==="login"?"auth.signIn":"auth.signUp")}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("div",{className:"flex-1 h-px bg-border"}),e.jsx("span",{children:t("auth.or")}),e.jsx("div",{className:"flex-1 h-px bg-border"})]})}),e.jsx("div",{className:"flex justify-center",children:e.jsx($,{clientId:"925093856675-mtsipr2ueapm3sqkftj2e1lfel5tfr53.apps.googleusercontent.com",onSuccess:()=>n("/"),onError:s=>a((s==null?void 0:s.message)||t("auth.oauthError")),mode:"button"})}),e.jsx("noscript",{children:e.jsx(S,{type:"button",onClick:T,children:t("auth.signInWithGoogle")})}),!1,x&&e.jsx("p",{className:"text-sm text-red-600 text-center",children:x})]})]})]})})}export{Z as default};
