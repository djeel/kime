import{b,a as k,k as N,r as i,s as m,j as e,I as w,B as g}from"./index-mjEV0DEk.js";import{P as y}from"./PageContainer-UeT_hR_D.js";function E(){const{t:s}=b(),{user:t,loading:d}=k(),l=N(),[r,p]=i.useState(""),[n,u]=i.useState("idle"),[f,h]=i.useState(!1),[x,o]=i.useState(null);i.useEffect(()=>{(async()=>{if(d)return;if(!t){l("/login");return}const{data:a}=await m.from("profiles").select("username").eq("user_id",t.id).maybeSingle();a!=null&&a.username&&l("/profile")})()},[t==null?void 0:t.id,d]),i.useEffect(()=>{if(!r){u("idle");return}const a=setTimeout(async()=>{u("checking");const c=r.trim().toLowerCase();if(!/^[a-z0-9_]{3,20}$/.test(c)){u("idle");return}const{data:j}=await m.from("profiles").select("user_id").eq("username",c).maybeSingle();u(j?"taken":"available")},400);return()=>clearTimeout(a)},[r]);const v=async()=>{o(null);const a=r.trim().toLowerCase();if(!/^[a-z0-9_]{3,20}$/.test(a)){o(s("auth.usernameInvalid"));return}if(n==="taken"||n==="checking"||!t)return;h(!0);const{error:c}=await m.from("profiles").upsert({user_id:t.id,username:a,email:t.email});if(h(!1),c){o(c.message);return}l("/profile")};return e.jsx(y,{title:s("auth.username"),className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md space-y-6 border rounded-2xl p-6 bg-card shadow-sm",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:s("auth.username")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s("auth.usernameRequired")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(w,{value:r,onChange:a=>p(a.target.value),placeholder:s("auth.usernamePlaceholder"),autoFocus:!0}),r&&e.jsx("p",{className:"text-xs text-muted-foreground",children:n==="checking"?s("auth.checking"):n==="available"?s("auth.available"):n==="taken"?s("auth.taken"):""}),x&&e.jsx("p",{className:"text-xs text-red-600",children:x}),e.jsx(g,{onClick:v,disabled:f||n==="taken"||n==="checking"||!r.trim(),className:"w-full",children:s(f?"onboarding.saving":"common.save")})]}),e.jsx("div",{className:"text-center",children:e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>l("/"),children:s("common.cancel")})})]})})}export{E as default};
